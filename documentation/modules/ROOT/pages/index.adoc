= Backup y Restore de máquinas virtuales
:page-layout: home
:!sectids:

[#operator]
== Revisa el operador de OADP

. Navega en el menú de la izquierda a *Operators* -> *Installed Operators* y revisa que `All projects` está seleccionado. Selecciona `OADP Operator`.
+
image::Backup/00_Left_Menu.png[]

. Revisa las *Provided APIs* disponibles. En este módulo usaremos las funciones de `Backup` y `Restore`.
+
image::Backup/01_Overview.png[]

. Navega a la pestaña llamada *DataProtectionApplication*. Este objeto representa la configuración de la instancia de OADP desplegada en este cluster.
+
image::Backup/02_DPA.png[]

. Selecciona `oadp-dpa` y revisa la definición _YAML_.
+
image::Backup/03_OADP_YAML.png[]
+
Tenga en cuenta que la instancia de *OADP* ha sido configurada añadiendo el plugin de `kubevirt` y que ha sido configurada para usar el bucket de *Red Hat Storage*.
+
En un entorno de producción normalmente usarías un sistema de almacenamiento externo, sin embargo, en este lab, estamos utilizando el almacenamiento interno de objetos por conveniencia.


[#backup]
== Crear un backup de una máquina virtual

Realizarás una copia de seguridad de la VM `fedora01`. La selección de los objetos de los que se realizará la copia de seguridad está definida por las etiquetas `app` y `vm.kubevirt.io/name`. Esto incluye la definición de VM, los discos y los objetos adicionales que utiliza la máquina virtual, como config maps y secretos.

. Regrese a la página principal del Operador haciendo clic en el nombre del Operador

WARNING: Debe estar seleccionado el proyecto "oadp-userX" según esté usando el usuario user1, user2 o user3.

. Ve a la pestaña de *Backup* y seleccione *Create Backup*
+
image::Backup/04_Backup_Tab.png[]

. Cambia de vista a _YAML view_ y reemplaza el siguiente contenido:
+
[source,yaml]
----
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: backup-fedora01
  labels:
    velero.io/storage-location: default
  namespace: oadp-{user1|user2|user3} 
spec:
  hooks: {}
  orLabelSelectors:
  - matchLabels:
      app: fedora01
  - matchLabels:
      vm.kubevirt.io/name: fedora01
  includedNamespaces:
  - vmexamples-{user1|user2|user3} 
  storageLocation: oadp-dpa-1
  ttl: 720h0m0s
----
+
Tenga en cuenta que el contenido de este YAML indica que se realizará una copia de seguridad de cualquier objeto con las etiquetas `app: fedora01` que estén creadas en el namespace `vmexamples-user1` o `vmexamples-user2` o `vmexamples-user3` *(DEBE ESPECIFICAR  CUAL DE LOS 3 USUARIOS ESTÁ USANDO EN LA SESIÓN)* en la ubicación especificada en la configuración de `DataProtectionApplication`.
+
[IMPORTANTE]
Si no tiene la máquina virtual `fedora01`, cambie los selectores de etiquetas en el YAML anterior para que coincidan con una máquina virtual en su entorno.


. Espere hasta que la columna `Status` cambie a `Completed`. Esto indica que se ha realizado una copia de seguridad exitosa de la máquina virtual.

+
image::Backup/06_Backup_Completed.png[]

[#restore]
== Restaura un backup

. Navega a *Virtualization* -> *VirtualMachines* y elimina la VM `fedora01`.

WARNING: Debe estar seleccionado el proyecto "vmexamples-userX" según esté usando el usuario user1, user2 o user3.

. Vuelve a la pestaña *Operators* -> *Installed Operators* y selecciona *OADP Operator*. 

WARNING: Debe estar seleccionado el proyecto "oadp-userX" según esté usando el usuario user1, user2 o user3.

. Cambia a la pestaña de *Restore* y selecciona *Create Restore*
+
image::Backup/09_Restore_Tab.png[]

. Cambia a la vista de YAML y reemplaza el contenido con el siguiente:
+
[source,yaml]
----
apiVersion: velero.io/v1
kind: Restore
metadata:
  name: restore-fedora01
  namespace: openshift-adp
spec:
  backupName: backup-fedora01
  includedResources: [] 
  excludedResources:
  - nodes
  - events
  - events.events.k8s.io
  - backups.velero.io
  - restores.velero.io
  restorePVs: true
----

. Espera hasta que la columna de `Status` cambie a `Completed`.
+
image::Backup/11_Restore_Completed.png[]

. Vuelve a la pestaña de *Virtualization* -> *Virtual Machines* y comprueba que se ha restaurado la VM `fedora01`.
+
image::Backup/12_VM_Restored.png[]

[#summary]
== Conclusiones 

La protección de las máquinas virtuales es un aspecto crítico de una plataforma de virtualización. OpenShift Virtualization proporciona múltiples métodos que permiten la protección nativa, por ejemplo, utilizando OADP o permitiendo la integración con otras soluciones de terceros. Si tiene cualquier duda sobre cómo proteger las máquinas virtuales, no dude en consultar a los supervisores del taller o comunicarse con su proveedor para determinar su compatibilidad con OpenShift Virtualization.